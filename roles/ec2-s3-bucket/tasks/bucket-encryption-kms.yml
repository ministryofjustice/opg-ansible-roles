---

- name: Get KMS Key metadata
  command: "aws kms describe-key --key-id alias/{{ default_encryption_kms_keyname }}"
  register: kms_metadata
  check_mode: no

- name: Get KMS Key ID
  set_fact:
    kms_key_id: "{{ (kms_metadata.stdout | from_json).[].KeyId }}"
  check_mode: no

- name: Make default encryption policy for s3 bucket
  template:
    src: default-encryption.json.j2
    dest: "{{ playbook_dir }}/default-encryption.json"

- name: Set bucket encryption
  command: "aws s3api put-bucket-encryption  \
            --bucket {{ bucket_name }}  \
            --server-side-encryption-configuration {{ playbook_dir }}/default-encryption.json"